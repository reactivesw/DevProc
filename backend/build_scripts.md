# Build Scripts
We use multiple build scripts to manage the build process. There is one top level `build.gradle` at the root dicretory of the repoistory. Other applicaiton build scripts are defined int `build_scripts` directory. 

Additionally, for code style, unit test, test coverage and code checking, we use a `code_analyzer_test_local` folder and a git submodule used to manage the configurations and perform tasks.  

All application build scripts mentioned below can be found in [resources/build_scripts](resources/build_scripts). You can cusotmize them for your application needs. Some build Scripts such as `build_setups.gradle`, `grpc.gradle` and `docker_build.gradle` can be used with minor changes or no changes. 

## 1 Initialize `build.gradle`
The top level build file is the `build.gradle` in the repository root folder.  It's recommended to create an `application_build` directory and put all used build scripts there. 

The `buildscript` section of `build.gradle` defines extra dependencies and their repostiories. Typical dependencies include 

* `spring-boot-gradle-plugin` for spring boot dependency managment.
* `jacoco-coverage` for unit test code coverage.
* `protobuf-gradle-plugin` for gRPC compiler.    
* `gradle-docker` for building docker image.  

When use the additional plugins, we need to add the corresponding dependencies in this section. The completed sample `build.gradle` file is given at the end of this document. Following are step by step instructions to create the build script files. 

## 2 Apply `build_setups.gradle` file
The first step is to create and apply [`buid_scripts/build_setups.gradle`](resources/build_scripts/build_setups.gradle)) to initialize repositories, apply java plugin and set gradle wrapper version. 

## 3 Apply `application_version.gradle` File
Create an [`build_scripts/application_version.gradle`](resources/build_scripts/application_version.gradle) script file. Use this file to set base name and version. 

## 4. Apply Application Dependencies Script
Create an `build_scripts/application_dependencies.gradle` file to include dependencies used in your application. 

When use Spring boot plugins such as, there is no need to specify versions for all Spring boot dependencies. Such dependencies usually have a name starting with 'spring-boot', for example: `spring-boot-starter-web` and `spring-session` don't need to specify version.

## 5. Apply gRPC Build Script 
Create an `build_scripts/grpc_build.gradle` when you use grpc in your application. Adding the `protobuf-gradle-plugin` dependency in the `buildscript` section of `build.gradle` and copying the file from [resources/build_scripts/grpc_build.gradle](resources/build_scripts/grpc_build.gradle) should be enough. 

## 6. Build Docker
Create an `build_scripts/docker_build.gradle` when you use grpc in your application. Adding the `gradle-docker` dependency in the `buildscript` section of `build.gradle` and copying the file from [resources/build_scripts/docker_build.gradle](resources/build_scripts/docker_build.gradle) should be enough.

## 7. Code Style, analyzer and Test 
It's a little bit tricky to perform these quality-checking tasks in the build process. We use a git submodule to store the team-wide configuration. Please follow the instructions in https://github.com/reactivesw/code_analyzer_test repository to configure build system to check code style, run code analyzer and unit test.


## 8. A Sample `build.gradle` File

```groovy
/*
 * The root build script file.
 * The "buildscript" section has to be the first item in the root file.
 * we use the syntax as generated by IntelliJ IDE
 */

buildscript {
  ext { springBootVersion = '1.4.1.RELEASE' }

  repositories {
    jcenter()
    mavenLocal()
    mavenCentral()
    maven {
      url 'http://dl.bintray.com/robfletcher/gradle-plugins'
      url 'https://repo.spring.io/libs-milestone'
    }
  }

  dependencies {
    // for spring boot
    classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")

    //for docker build
    classpath('se.transmode.gradle:gradle-docker:1.2')

    // for unit test code coverage  -- need to find a way to put it in its file
    classpath('com.palantir:jacoco-coverage:0.4.0')

    //for proto buffer
    classpath('com.google.protobuf:protobuf-gradle-plugin:0.8.0')
  }
}

// init repository, java, wrapper
apply from: 'buid_scripts/build_setups.gradle'

// init application version settings
apply from: 'build_scripts/application_version.gradle'

// application build script
apply from: 'build_scripts/application_dependencies.gradle'

//build grpc files
apply from: 'build_scripts/grpc_build.gradle'

// build docker image task
apply from: 'build_scripts/docker_build.gradle'

// these two files are for code analyzer, unit test and code coverage check
apply from: 'code_analyzer_test_local/code_analyzer.gradle'
apply from: 'code_analyzer_test_local/code_test_coverage.gradle'
```
